# kubernetes?
- 컨테이너 오케스트레이션 툴
  - 여러 서버에서 컨테이너 관리
  - 컨테이너 배포
  - 네트워크 관리
  - 부하분산
  - 장애 발생 시 자동 복구

- 선언적으로 오케스트레이션 할 수 있다. (.yaml)
- 컨테이너가 죽었을 때 스스로 복구 시킨다.
- 컴퓨팅 리소스가 낭비되지 않도록 효율적으로 배포 위치를 찾아준다.
- 클러스터 안에 구성 레지스트리를 기반으로 동적으로 애플리케이션이 어디있는지 찾아낸다.

## k8s Components

[k8s diagram](static/k8s_cluster_diagram.svg)

### 컨트롤 플레인
- 클러스터에 관한 전반적인 결정을 수행
  - ex) Node의 리소스 사용 상황을 확인하고, 컨테이너를 가동할 노드를 자동으로 선택 등
- 클러스터 이벤트를 감지하고 반응
  - ex) replicas 요구 조건이 충족되지 않은 경우 새로운 파드를 구동 시키는 것 등

#### kube-apiserver
- Node 리소스 정보를 관리하기 위한 REST API
- 각 컴포넌트로부터 리소스 정보를 받아 etcd에 저장하는 역할을 담당
- kubectl 커맨드를 사용하여 API Server에 접근할 수 있음

#### etcd
- 클러스터 구성을 유지하는 분산 Key-Value Store

#### kube-scheduler
- 애플리케이션을 어떤 노드에 배포할지 관리하는 컴포넌트
- 클러스터의 상태를 확인하고, 빈 공간을 가진 노드를 찾아 pod를 실행시키는 스케줄링 담당

#### kube-controller-manager
- 클러스터 상태를 감시하고 본래 되어야 할 상태를 유지하는 컴포넌트
- 사용자가 정의한 상태와 현재 상태를 비교하여, 정의한 상태가 되도록 유지하는 역할 담당

#### cloud-controller-manager
- 클라우드별 컨트롤 로직을 포함하는 컴포넌트
- 클라우드 공급자의 API에 연결하고 클라우드 플랫폼과 상호작용하는 컴포넌트와 클러스터와 상호 작용하는 컴포넌트를 분리할 수 있음
- 로컬에는 k8s 클러스터를 띄울 때에는 존재하지 않음


### Node
- 애플리케이션 컨테이너가 올라가는 서버
- 노드의 개수는 워크로드, 부하, 규모에 따라 다르지만 개수가 늘어날 수록 가용성이 높아진다.

#### kubelet
- Pod에서 스펙에 맞게 컨테이너가 확실히 동작하도록 관리

#### kube-proxy
- 노드에서 실행되는 네트워크 프록시, 서비스의 구현체
- Node의 네트워크 규칙을 유지관리하며 내부 네트워크 세션이나 클러스터 바깥에서 pod로 네트워크 통신할 수 있도록 해줍니다.

#### 컨테이너 런타임
- 컨테이너 실행을 담당하는 소프트웨어

## k8s object
- k8s 시스템에서 영속성을 가지는 오브젝트
- 클러스터의 상태를 나타내기 위해 오브젝트를 이용
  - 어떤 컨테이너화된 애플리케이션이 어느 노드에서 동작 중인지
  - 그 애플리케이션이 이용할 수 있는 리소스
  - 그 애필르케이션이 어떻게 재구동 정책, 업그레이드, 그리고 내고장성과 같은 것에 동작해야 하는지 등의 정책

### 오브젝트 spec과 status
- spec
  - 오브젝트를 생성할 때 리소스의 의도한 상태에 대한 설정
- status
  - k8s에 의해 제공되고 업데이트된 오브젝트의 현재 상태
- 컨트롤 플레인은 계속하여 spec과 status가 일치하도록 끊임없이 관리한다.

### 오브젝트 기술하기
- 오브젝트의 기본 설정과 더불어 의도 상태를 spec에 명시해주어야 한다.
- 대부분의 경우, 정보를 .yaml 파일로 kubectl 에게 제공한다.


#### 요구되는 필드
apiVersion - 이 오브젝트를 생성하기 위해 사용하고 있는 쿠버네티스 API 버전이 어떤 것인지
kind - 어떤 종류의 오브젝트를 생성하고자 하는지
metadata - 이름 문자열, UID, 그리고 선택적인 네임스페이스를 포함하여 오브젝트를 유일하게 구분지어 줄 데이터
spec - 오브젝트에 대해 어떤 상태를 의도하는지



## k8s 리소스
### Pod
애플리케이션 기본 실행 단위

### ReplicaSet
Pod의 개수를 지정된 수 만큼 안정적으로 유지하는 장치

### Deployment
애플리케이션의 배포 단위 관리
Pod와 ReplicaSet에 대한 선언적 업데이트 제공

### DaemonSet
node에 하나의 Pod를 실행시키고 싶을 경우 사용
ReplicaSet과 달리 레플리카 수를 지정할 수 없음
kube-proxy도 DaemonSet을 사용하여 동작

ex) fluentd

### StatefulSet
- DB와 같이 영구 데이터와 연계되는 경우, 상태를 유지할 필요가 있을 때 사용
- Deployment와 동일하게 Pod을 관리하지만, Pod의 고유성을 보장해주는 측면에서 다르다.

ex) logstash

### Job
- 실행 완료 후 중단되는 작업
- 단 한 번의 작업을 나타냄

### CronJob
- 스케줄에 따라 반복되고 사라지는 작업

### Service
- 클러스터 안에서 실행된 Pod에 접근할 때 사용
- node에 동적으로 pod들이 할당되는데 정적으로 접근할 수 있는 방법을 제공
- ClusterIp, NodePort, LoadBalancer, ExternalName 4가지 타입이 있음

### Ingress
- 클러스터 외부에서 접근할 수 있도록 해줌
- HTTP(s) 경로 노출
- 로드밸런서, URL 경로, 명칭 기반의 가상 호스팅 등을 제공
- Ingress Controller와 같이 있어야 함

### Ingress Controller
- 인그레스 컨트롤러는 클러스터와 함께 자동으로 실행되지 않는다.
- nginx, aws, gce 등이 지원

### ConfigMap
- 애플리케이션 설정 정보 등을 Pod에서 참조할 수 있도록 해주는 역할
- Volume으로 마운트하거나 환경 변수로 취급 가능

### Secrets
- ConfigMap과 유사하지만 좀 더 Sensitive한 데이터를 다룸
- etcd에 암호화 되어 관리됨


## 참고 자료
- https://kubernetes.io/ko/docs/concepts/overview/components/