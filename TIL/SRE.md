# Devops와 SRE

- Devops는 개발과 운영의 분단현상을 해결하기 위한 방법론이자 하나의 조직문화에 대한 방향성이다.
- SRE는 Devops를 만들기 위한 프랙티스이자 가이드이다.
- SRE의 3가지 방향
    - 가용성에 대한 명확한 정의
    - 가용성 목표 정의
    - 장애 발생에 대한 계획
- 개발자 외의 다른 직군도 원칙에 동의하여 장애에 대한 책임을 모두 공유하도록 하였다.
- SRE는 **단순한 운영팀이 아니라 문화와 운영 프로세스 팀 구조등 모든 것을 포괄하는 개념**이다.

# SRE Engineer가 하는 일

## Metric & Monitoring

- 모니터링 지표(SLI) 설정
- 안정성 목표(SLO)를 세우고 지표 개선
- 지표를 분석하고 인사이트를 도출하기
- 모든 것을 데이터화 하고, 데이터를 기반으로 의사결정 한다.

## Capacity Planning

- 시스템 운영을 위해 필요한 충분한 리소스(서버, CPU, 메모리 등) 확보
- 비즈니스 성장 뿐만 아니라 이벤트성 성장에도 유연하게 대응할 수 있어야 한다.
- 시스템 자원을 확보하는 것은 리소스를 단순히 늘리기만 하는 것이 아니라, 그 위에서 동작하는 소프트웨어에 대한 성능 최적화도 포함한다.

## Change Management

- 소프트웨어 배포/업데이트, 인프라 변경과 같은 시스템 변경
    - 시스템 장애의 70%가 시스템에 변경을 주는 경우에 발생
    - 사람이 시스템 변경에 관여하지 않도록 프로세스에서 사람을 제외하고 자동화하는 식으로 개선
- 자동화 Best Practice
    - 점진적 배포와 변경
    - 배포 후 장애가 발생했을 때, 정확하게 해당 문제를 찾을 수 있도록 하는 것
    - 문제가 발생하였을 때 빠르게 롤백할 수 있도록 하는 것
- 자동화는 릴리즈의 일부일 뿐이며 코드 관리, 버전 관리, 테스트 등을 통해 잠재적인 문제가 발생하지 않도록 해야한다.

## Emergency Response

- MTTF(Mean Time to failure): 장애가 발생하지 않고 얼마나 정상 작동했는지
- MTTR(Mean Time to Response): 장애를 복구하는데까지 드는 시간
- 사람의 실수를 줄이기 위해서 각 단계들은 자동화 시켜두고, 사람이 해야하는 일을 매뉴얼화 해야 한다.
- 어떻게 해결해야 하는지를 정의한 Playbook을 만들고, 장애 복구 모의 훈련을 지속하여 프로세스에 익숙해지도록 해야한다.
    - Playbook이 없을때보다 있을 때 MTTR이 3배 이상 낮다는 연구가 있다.

## Culture

- SRE 문화를 전반적으로 만들고 지켜나가는 작업을 해야 한다.
- 좋은 SRE문화를 만들어나가는 3가지 가이드
    - **데이터에 기반한 합리적 의사 결정**
        - 사내 모든 구성원이 error budget과 같은 원칙에 동의하고, 이러한 결정은 데이터를 기반으로 되어야 한다.
        - 경영진의 지시로 인해서 모든 의사결정이 무너져서는 안된다.
    - **서로 비난하지 않고, 장애 원인을 분석하고 이를 예방하는 포스트모템 문화**
        - 장애가 발생한 원인을 잘 분석하고, 다음에는 발생하지 않도록 하는데에 초첨을 맞추자.
            - 함께 자라기에서 이야기하는 실수 예방이 아닌, **실수 관리에 초점을 맞추기**
        - 사람이 실수할 수 있는 프로세스가 있다면 개선하고 Playbook에 반영해야한다.
    - **책임을 나눠가지는 문화**
        - 장애에 대한 책임을 나눠가지는 문화를 가져야 한다.
        - 장애는 하나의 이유가 아닌 복합적인 이유에서 발생한다.
        - 누군가를 blame하지 않도록 하기보다는 개개인이 책임을 갖고, 장애를 없애기 위한 노력을 할 수 있는 동기를 만들기 위함이다.

# SRE 주요 지표

## SLI (Service Level Indicator)

- 서비스에 대한 수준을 측정하고 정량적으로 정의한 지표
- 절대적인 값을 사용하기도 하지만, `측정값/이상적인 값`과 같은 상대적인 지표를 사용하는 것이 이해하기 쉽다.
    - 한 달간 30분의 장애 상황이 난 경우,
        - 절대적인 값: 30분
        - 상대적인 값: `30일-30분/30일 * 100 = 99.9305%`
- 주로 사용하는 지표들
    - 응답 시간 (Request Latency): 시스템 응답시간
    - 에러율 (Error rate): 전체 요청에서 실패한 요청의 비율
    - 처리량(Throughput): 일반적으로 초당 처리량으로 측정하고 TPS, QPS라는 단위를 사용
    - 가용성(availability): 시스템 업타임 비율
    - 내구성(Durability): 데이터가 유실되지 않을 확률(스토리지에만 해당)
- 지표들은 시스템 특성에 따라 적절한 것을 고르면 된다.
    - 웹, 모바일과 같은 제품은 주로 가용성, 응답시간, 처리량을 확인한다.
- SLI 지표들은 평균값보다는 값의 분포를 퍼센타일에 따른 분포를 사용하는 것이 좋다.
    - 50%, 85%, 95%, 99% 등으로 나누어 응답시간 분포를 보는식으로 해야한다.
    - 평균값을 이용하면 지표가 희석되어 제대로된 평가를 내리기 힘들어진다.
        - ex. 평균 응답시간이 0.3초지만, 가장 오래걸리는 응답시간이 10초인 상황이 생길 수 있고 평균을 이용하면 이 상황을 인지하기 힘들다.

## SLO (Service Level Object)

- 각 SLI 지표에 대한 목표값
- `매주, 99% of REST API 호출의 응답시간을 100ms 이하로 만든다.` 와 같은 목표를 세울 수 있다.
    - `매주, 99% of REST API 호출의 응답시간을` 이 SLI가 되고, `100ms 이하로 만든다.` 가 Object가 된다.
- SLO는 제공자가 아닌 사용자 관점에서 서비스에 얼마나 영향을 받는지를 중심으로 결정되어야 한다.

### 좋은 SLO 설정하기

- **단순할 것**
    - 개발/운영 조직 이외에도 다른 직군도 동의하고 사용하는 지표이기 때문에 단순하고 이해하기 쉬워야 한다.
- **완벽한 값을 사용하지 말 것**
    - 완벽한 시스템은 존재할 수 없고, 현실성이 없다.
    - 100% 업타임 시스템은 존재하지 않는다.
- **되도록 적은 SLO만 정의할 것**
    - 많은 수의 SLO는 관리가 되기 어렵기 때문에 적은 수의 SLO를 사용하되, 비즈니스 의사결정의 기준으로 사용될 수 있는 SLO만 사용한다.
    - 의사결정에 도움이 되지 않는다면 쓸모없는 SLO이다.
- **지속적이고 점진적으로 SLO 값을 발전 시킬 것**
    - SLO 값은 조직의 능력이나 비즈니스 상황에 따라 지속적으로 조정해야 한다.
    - SLO를 낮은 값부터 시작해서 점점 높은 수준으로 발전시켜나가야한다.
    - 높은 값을 설정하고 달성하지 못해 점차적으로 SLO값을 낮추는 것은 나쁜 습관이 만들어질 수 있기 때문에 적절치 못하다.

### SLO 기대치 관리

- **SLO의 최소/최대 범위 지정**
    - 최대값만 지정하는 것보다 최소값도 지정하면, 성능 향상에 대한 목표를 잡을 수 있게 된다.
    - `최소값 ≤ SLO ≤ 목표값`으로 지정하면 너무 과한 최적화를 하기 위한 오버엔지니어링을 막을 수 있다.
- **여유값을 둘것**
    - 외부에 SLO를 공유해야 하는 경우, 내부 SLO와 분리하고 내부 SLO보다 여유값을 두어 설정한다.
    - 문제 발생시 어느정도 여유 폭을 가질 수 있다.
- **Don't overachieve**
    - 성능 최적화를 하여 SLO에 정의된 것보다 높게 만들면, 사용자는 그 기준에 익숙해지게 된다.
    - 목표값이 500ms였는데 300ms로 줄였다가 500ms로 느려지면 성능이 나빠졌다고 착각한다.

# Error Budget

- Error Budget = 100& - availability target
- 한달에 SLO가 99.99%를 목표치로 잡은 경우, 한달간 0.01%의 error budget을 갖게 된다.
- error budget이 더이상 남지 않게 된다면 시스템 가용성을 높이기 위한 작업을 진행한다.
- error budget을 이용하면 개발팀 역시 책임감을 갖고, 조금더 신중하게 개발할 수 있게 된다.

# SRE 스터디

- 장애상황에서 가장 중요한건 시스템이 돌아가게 만드는 것
- 시스템에 어떤 문제가 있는지 항상 명시적으로 볼 수 있고 알림도 받을 수 있어야한다.
- 가용성이 100%인 서비스는 없으니 에러 예산을 잡고 관리하자
- 누구나 트러블 슈팅할 수 있다. 당황하지말고 모르겠으면 동료들에게 도움을 구하자
- 평소에 일어날 법한 에러 상황에 대해서 테스트해보자.
- 포스트모템 꼭 하자
- 주요 행동 지표와 아닌 것을 분류해야함. 주요지표는 아래와 같음
    - 가용성
    - 레이턴시
    - 처리량
    - 정합성
- 목표로 평균/중간값은 쓰지말자.
    - 적립이 10초 걸려도 평균/중간값은 0.7초일 수 있으니까.
- [https://sre.google/sre-book/table-of-contents/](https://sre.google/sre-book/table-of-contents/)
